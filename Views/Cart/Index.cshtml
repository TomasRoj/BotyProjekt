@using System.Text.Json
<main>
    <div class="container">
        <div class="breadcrumbs">
            <a href="@Url.Action("Index", "Home")" style="color: var(--primary-red); text-decoration: underline;">Domů</a>
            <span>&gt;</span>
            <span style="color: #333; text-decoration: underline;">Poptávka</span>
        </div>

        <div class="demand-layout">
            <div class="demand-form-wrapper">
                <h1 style="color: var(--dark-blue); font-size: 32px; margin-bottom: 10px;">Poptávkový formulář</h1>
                <p style="margin-bottom: 25px; font-size: 14px; color: #555;">Vyplňte formulář níže a my se Vám ozveme, jakmile to půjde.</p>

                <form asp-controller="Cart" asp-action="CheckoutSubmit" method="post" class="demand-form">
                    @Html.AntiForgeryToken()

                    <div class="form-row-dual">
                        <div class="form-group">
                            <label for="jmeno">Jméno</label>
                            <input type="text" id="jmeno" name="jmeno" placeholder="Zadejte své jméno..." required>
                        </div>
                        <div class="form-group">
                            <label for="prijmeni">Příjmení</label>
                            <input type="text" id="prijmeni" name="prijmeni" placeholder="Zadejte své příjmení..." required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">E-mail</label>
                        <input type="email" id="email" name="email" placeholder="Zadejte svůj e-mail..." required>
                    </div>

                    <div class="form-group">
                        <label for="telefon">Telefon</label>
                        <input type="tel" id="telefon" name="telefon" placeholder="Zadejte svůj telefon...">
                    </div>
                    <div class="form-group">
                        <label for="address">Adresa</label>
                        <input type="text" id="address" name="address" placeholder="Zadejte svoji adresu..." required>
                    </div>

                    <div class="form-group">
                        <label for="zeme">Země</label>
                        <div class="select-wrapper">
                            <select id="zeme" name="zeme" required>
                                <option value="" disabled selected>Vyber zemi</option>
                                <option value="Česká republika">Česká republika</option>
                                <option value="Slovensko">Slovensko</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="payment-label-title">Způsob platby</label>
                        <div class="payment-options">
                            <label class="radio-container">
                                Hotově
                                <input type="radio" name="platba" value="hotove">
                                <span class="checkmark"></span>
                            </label>
                            <label class="radio-container">
                                Převodem
                                <input type="radio" name="platba" value="prevodem" checked>
                                <span class="checkmark"></span>
                            </label>
                            <label class="radio-container">
                                Kartou
                                <input type="radio" name="platba" value="kartou">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn-red" style="margin-top: 16px;">Odeslat poptávku</button>
                </form>
            </div>

            <div class="demand-image">
                @{
                    var cartJson = Context.Session.GetString("Cart");
                    List<CartViewItem> cartItems = new();
                    if (!string.IsNullOrEmpty(cartJson))
                    {
                        try
                        {
                            cartItems = JsonSerializer.Deserialize<List<CartViewItem>>(cartJson) ?? new List<CartViewItem>();
                        }
                        catch
                        {
                            cartItems = new List<CartViewItem>();
                        }
                    }

                    decimal total = cartItems.Sum(i => i.Price * i.Quantity);
                }

                @if (TempData["CartMessage"] != null)
                {
                    <div style="background-color: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 12px; border-radius: 4px; margin-bottom: 16px;">
                        @TempData["CartMessage"]
                    </div>
                }

                <h2 style="margin-bottom:10px;">Váš košík</h2>

                @if (!cartItems.Any())
                {
                    <p>Košík je prázdný.</p>
                    <a asp-controller="Product" asp-action="Index" class="btn-outline">
                        Pokračovat v nákupu
                    </a>
                }
                else
                {
                    <table class="cart-table" style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="text-align:left; border-bottom:1px solid #e5e5e5;">
                                <th style="padding:8px;">Produkt</th>
                                <th style="padding:8px;">Množství</th>
                                <th style="padding:8px;">Cena / ks</th>
                                <th style="padding:8px;">Mezisoučet</th>
                                <th style="padding:8px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in cartItems)
                            {
                                <tr style="border-bottom:1px solid #f0f0f0;">
                                    <td style="padding:10px; vertical-align:middle;">
                                        <div style="display:flex; align-items:center; gap:12px;">
                                            <img src="@Url.Content("~/" + (string.IsNullOrEmpty(item.ImageUrl) ? "obrazky/placeholder.png" : item.ImageUrl))" alt="@item.Name" style="width:70px; height:70px; object-fit:cover; border-radius:6px;">
                                            <div>
                                                <a asp-controller="Product" asp-action="Detail" asp-route-id="@item.ProductId" style="font-weight:600; color:#222;">@item.Name</a>
                                            </div>
                                        </div>
                                    </td>
                                    <td style="padding:10px; vertical-align:middle;">
                                        <form asp-controller="Cart" asp-action="UpdateQuantity" method="post" style="display:flex; gap:8px; align-items:center;">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="productId" value="@item.ProductId" />
                                            <input type="number" name="quantity" value="@item.Quantity" min="1" style="width:70px; padding:6px; border:1px solid #ccc; border-radius:4px;">
                                            <button type="submit" class="btn-outline" style="padding:6px 8px;">Uložit</button>
                                        </form>
                                    </td>
                                    <td style="padding:10px; vertical-align:middle;">@item.Price.ToString("C0")</td>
                                    <td style="padding:10px; vertical-align:middle;">@( (item.Price * item.Quantity).ToString("C0") )</td>
                                    <td style="padding:10px; vertical-align:middle;">
                                        <form asp-controller="Cart" asp-action="Remove" method="post" onsubmit="return confirm('Opravdu odebrat položku?');">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="productId" value="@item.ProductId" />
                                            <button type="submit" class="btn-link" style="color:var(--primary-red); background:none; border:none; cursor:pointer;">Odebrat</button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:16px;">
                        <div>
                            <a asp-controller="Product" asp-action="Index" class="btn-outline">
                                Pokračovat v nákupu
                            </a>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</main>

@functions {
    public class CartViewItem
    {
        public int ProductId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string ImageUrl { get; set; } = string.Empty;
        public decimal Price { get; set; }
        public int Quantity { get; set; }
    }
}
